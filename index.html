<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BEWOOFED â€” Refill</title>

  <style>
    :root{
      --border:#e6e6e6;
      --muted:#666;
      --bg:#fff;
      --chip:#f4f4f4;
      --ok:#e9ffe9;
      --bad:#ffe9e9;
    }
    body{font-family:system-ui,Arial;max-width:920px;margin:1.2rem auto;padding:1rem;padding-bottom:170px;background:#fff}
    h2{margin:0 0 1rem 0;display:flex;align-items:center;gap:10px}
    .logo{height:46px;width:auto;border-radius:10px;border:1px solid #eee;background:#fafafa}
    .card{border:1px solid var(--border);border-radius:16px;padding:14px;background:var(--bg)}
    .sep{height:16px}
    .section-title{margin:0 0 10px 0;font-size:18px}
    label{display:block;margin:10px 0 6px;font-weight:700}
    input[type="text"]{
      padding:10px;font-size:16px;border:1px solid #ccc;border-radius:12px;width:100%;box-sizing:border-box
    }
    textarea{
      width:100%;
      padding:10px;
      font-size:15px;
      border-radius:12px;
      border:1px solid #ccc;
      box-sizing:border-box;
      resize:vertical;
    }
    .hint{color:var(--muted);font-size:13px;margin-top:6px}

    /* LISTAS */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:grid;
      grid-template-columns: 64px 1fr auto;
      gap:12px;
      align-items:center;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .pic{
      width:64px;height:64px;object-fit:cover;border-radius:12px;border:1px solid #ddd;background:#fafafa
    }
    .meta{min-width:0}
    .name{font-weight:700;line-height:1.2}
    .subrow{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:13px}
    .pill{background:var(--chip);padding:4px 8px;border-radius:999px}
    .price{font-weight:800;color:#111}

    /* Stepper compacto */
    .qtywrap{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .stepper{display:flex;align-items:center;border:1px solid #d6d6d6;border-radius:12px;overflow:hidden}
    .stepper button{
      width:38px;height:36px;border:0;background:#f7f7f7;font-size:18px;cursor:pointer
    }
    .stepper input{
      width:52px;height:36px;border:0;text-align:center;font-size:16px;outline:none
    }
    .lineTotal{font-size:12px;color:var(--muted)}
    .lineTotal b{color:#111}

    /* checkboxes */
    .checks{display:flex;flex-direction:column;gap:10px}
    .check-row{display:flex;align-items:center;gap:10px}
    .check-row input{width:20px;height:20px}

    button#btn{
      margin-top:14px;padding:12px 16px;font-size:18px;border:0;border-radius:14px;cursor:pointer;
      background:#111;color:#fff;width:100%
    }
    button#btn:disabled{opacity:.6;cursor:not-allowed}
    .ok{margin-top:12px;padding:12px;border-radius:12px;background:var(--ok)}
    .bad{margin-top:12px;padding:12px;border-radius:12px;background:var(--bad)}

    /* barra fija con resumen */
    .totalbar{
      position:fixed;left:0;right:0;bottom:0;
      background:#fff;border-top:1px solid var(--border);
      padding:10px 14px;
      display:flex;justify-content:center;
      z-index:999;
    }
    .totalinner{
      width:min(920px, 100%);
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .sumgrid{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:6px 12px;
      align-items:center;
    }
    .sumgrid .k{font-size:12px;color:var(--muted)}
    .sumgrid .v{font-size:12px;color:#111;text-align:right;font-weight:700}
    .sumgrid .v.big{font-size:18px;font-weight:900}
    .miniRight{
      text-align:right;
      font-size:12px;
      color:var(--muted);
      line-height:1.2;
    }

    @media (max-width:520px){
      body{padding:12px;padding-bottom:180px}
      .item{grid-template-columns: 56px 1fr auto}
      .pic{width:56px;height:56px}
      .stepper button{width:34px}
      .stepper input{width:46px}
    }
  </style>
</head>

<body>
  <h2>
    <img class="logo" id="logo" alt="BEWOOFED logo">
    BEWOOFED â€” Refill
  </h2>

  <div class="card">
    <!-- (1) AFM: sin nota â€œ9 dÃ­gitosâ€ + placeholder 123456789 -->
    <label for="afm">Î‘Î¦Îœ</label>
    <input id="afm" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Ï€.Ï‡. 123456789" />
    <div class="hint">Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Î‘Î¦Îœ ÎºÎ±Î¹ ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€Î¿ÏƒÏŒÏ„Î·Ï„ÎµÏ‚.</div>

    <div class="sep"></div>

    <h3 class="section-title">Î¤Î± Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Î± Î¼Î±Ï‚</h3>
    <div id="productos" class="list"></div>

    <div class="sep"></div>

    <h3 class="section-title">Î¤ÏÏŒÏ€Î¿Î¹ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚</h3>
    <div class="checks">
      <div class="check-row">
        <input type="checkbox" id="ship_boxnow">
        <label for="ship_boxnow" style="margin:0;font-weight:650;">BOX NOW</label>
      </div>
      <div class="check-row">
        <input type="checkbox" id="ship_acs">
        <label for="ship_acs" style="margin:0;font-weight:650;">ACS</label>
      </div>
      <div class="check-row">
        <input type="checkbox" id="ship_metaforiki">
        <label for="ship_metaforiki" style="margin:0;font-weight:650;">ÎˆÏ‡Ï‰ Î´Î¹ÎºÎ® Î¼Î¿Ï… Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ®</label>
      </div>
    </div>

    <div class="sep"></div>

    <h3 class="section-title">Î¤Î± ÎµÎ¾Ï„ÏÎ±Î´Î±ÎºÎ¹Î± Î¼Î±Ï‚</h3>
    <div id="extras" class="list"></div>

    <div class="sep"></div>

    <h3 class="section-title">Î‘Ï†Î®ÏƒÏ„Îµ Î¼Î±Ï‚ Î­Î½Î± ÏƒÏ‡ÏŒÎ»Î¹Î¿</h3>
    <textarea id="comment" rows="3" placeholder="Î“ÏÎ¬ÏˆÏ„Îµ ÎµÎ´Ï Ï„Ï…Ï‡ÏŒÎ½ Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚ Î® Î±Î½Î¬Î³ÎºÎµÏ‚..."></textarea>

    <button id="btn">Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</button>
    <div id="result"></div>
  </div>

  <!-- Barra fija resumen con Î¦Î Î‘ -->
  <div class="totalbar">
    <div class="totalinner">
      <div class="sumgrid">
        <div class="k">ÎšÎ±Î¸Î±ÏÎ® Î±Î¾Î¯Î±</div><div class="v"><span id="subTotal">0,00</span> â‚¬</div>
        <div class="k">Î¦Î Î‘ 24%</div><div class="v"><span id="vatValue">0,00</span> â‚¬</div>
        <div class="k">Î£ÏÎ½Î¿Î»Î¿</div><div class="v big"><span id="grandTotal">0,00</span> â‚¬</div>
      </div>
      <div class="miniRight">
        <div>Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±:</div>
        <div><b><span id="itemsCount">0</span></b> Ï„ÎµÎ¼.</div>
      </div>
    </div>
  </div>

<script>
  // âœ… Pon aquÃ­ tu TOKEN y el chat_id del GRUPO
  const TOKEN = "7993916106:AAEN_n8R8qh2DIn2gUKZBH3CkNj1blIKArk";
  const CHAT_ID = "1446479004"; // âš ï¸ Debe ser el del grupo (normalmente -100xxxxxxxxxx)

  const VAT_RATE = 0.24;

  // fallback de formatos (incluye mayÃºsculas)
  const IMG_EXTS = ["png","jpg","jpeg","webp","JPG","JPEG","PNG","WEBP"];

  function setImgWithFallback(imgEl, basePathNoExt) {
    let i = 0;
    const tryNext = () => {
      if (i >= IMG_EXTS.length) return;
      imgEl.src = `${basePathNoExt}.${IMG_EXTS[i++]}`;
    };
    imgEl.onerror = () => tryNext();
    tryNext();
  }

  async function buscarPorAFM(afm) {
    const res = await fetch("tiendas.json", { cache: "no-store" });
    const data = await res.json();
    return data.find(x => String(x.afm).trim() === String(afm).trim()) || null;
  }

  function eur(n){
    const x = Number(n) || 0;
    return x.toLocaleString("el-GR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function getQty(id){
    const el = document.getElementById(id);
    return Math.max(0, parseInt(el.value || "0", 10) || 0);
  }

  function setQty(id, val){
    const el = document.getElementById(id);
    el.value = String(Math.max(0, val));
    updateTotals();
  }

  // âœ… Productos y precios (SIN Î¦Î Î‘)
  const PRODUCTOS = [
    { id:"p1", imgBase:"img/p1", name:"ÎœÎ±Î½Ï„Î¹Î»Î¬ÎºÎ¹Î± ÏƒÎºÏÎ»Ï‰Î½ 80Ï„Î¼Ï‡ Î‘Î»ÏŒÎ· Î²Î­ÏÎ±", price: 3.19 },
    { id:"p2", imgBase:"img/p2", name:"ÎšÎ¿Î¼Ï€Î¿ÏƒÏ„Î¿Ï€Î¿Î¹Î®ÏƒÎ¹Î¼Î± ÏƒÎ±ÎºÎ¿Ï…Î»Î¬ÎºÎ¹Î± 120Ï„Î¼Ï‡ Bart", price: 4.84 },

    { id:"p3", imgBase:"img/p3", name:"Bandana Small Bewoofed x Wildbarks",  price: 6.00 },
    { id:"p4", imgBase:"img/p4", name:"Bandana Medium Bewoofed x Wildbarks", price: 6.50 },
    { id:"p5", imgBase:"img/p5", name:"Bandana Large Bewoofed x Wildbarks",  price: 7.00 },

    { id:"p6", imgBase:"img/p6", name:"Î˜Î®ÎºÎ· Î³Î¹Î± ÏÎ¿Î»Î¬ Ï…Ï†Î±ÏƒÎ¼Î¬Ï„Î¹Î½Î· Green Bewoofed x Wildbarks", price: 5.50 },
    { id:"p7", imgBase:"img/p7", name:"Î˜Î®ÎºÎ· Î³Î¹Î± ÏÎ¿Î»Î¬ Ï…Ï†Î±ÏƒÎ¼Î¬Ï„Î¹Î½Î· Figo Bewoofed x Wildbarks",  price: 5.50 }
  ];

  // âœ… EXTRAS (3) Quitados: floor stand / table wipes / table bags
  const EXTRAS = [
    { id:"ex_stickers", imgBase:"img/ex_stickers", name:"Branded stickers" },
    { id:"ex_brochure", imgBase:"img/ex_brochure", name:"Brochure" },
    { id:"ex_poster_wipes", imgBase:"img/ex_poster_wipes", name:"Poster Don't forget your wipes" },
    { id:"ex_flag", imgBase:"img/p8", name:"Î£Î·Î¼Î±Î¯Î± (Bandera) â€” Bewoofed" }
  ];

  function updateTotals(){
    let subtotal = 0;
    let count = 0;

    for (const p of PRODUCTOS){
      const q = getQty(p.id);
      count += q;
      const line = q * (Number(p.price)||0);
      subtotal += line;

      const lt = document.getElementById(`lt_${p.id}`);
      if (lt) lt.innerHTML = `Î£ÏÎ½Î¿Î»Î¿: <b>${eur(line)}â‚¬</b>`;
    }

    const vat = subtotal * VAT_RATE;
    const total = subtotal + vat;

    document.getElementById("subTotal").textContent = eur(subtotal);
    document.getElementById("vatValue").textContent = eur(vat);
    document.getElementById("grandTotal").textContent = eur(total);
    document.getElementById("itemsCount").textContent = String(count);
  }

  function renderProductos() {
    const root = document.getElementById("productos");
    root.innerHTML = "";

    for (const p of PRODUCTOS) {
      const row = document.createElement("div");
      row.className = "item";

      const img = document.createElement("img");
      img.className = "pic";
      img.alt = p.name;
      setImgWithFallback(img, p.imgBase);

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = p.name;

      const sub = document.createElement("div");
      sub.className = "subrow";
      sub.innerHTML = `<span class="pill">Î¤Î¹Î¼Î® (Ï‡Ï‰ÏÎ¯Ï‚ Î¦Î Î‘): <span class="price">${eur(p.price)}â‚¬</span></span>`;

      meta.appendChild(name);
      meta.appendChild(sub);

      const qtywrap = document.createElement("div");
      qtywrap.className = "qtywrap";

      const step = document.createElement("div");
      step.className = "stepper";

      const minus = document.createElement("button");
      minus.type = "button";
      minus.textContent = "âˆ’";
      minus.onclick = () => setQty(p.id, getQty(p.id) - 1);

      const qty = document.createElement("input");
      qty.type = "text";
      qty.inputMode = "numeric";
      qty.pattern = "[0-9]*";
      qty.value = "0";
      qty.id = p.id;
      qty.oninput = () => {
        qty.value = qty.value.replace(/[^\d]/g, "");
        if (qty.value === "") qty.value = "0";
        updateTotals();
      };

      const plus = document.createElement("button");
      plus.type = "button";
      plus.textContent = "+";
      plus.onclick = () => setQty(p.id, getQty(p.id) + 1);

      step.appendChild(minus);
      step.appendChild(qty);
      step.appendChild(plus);

      const lineTotal = document.createElement("div");
      lineTotal.className = "lineTotal";
      lineTotal.id = `lt_${p.id}`;
      lineTotal.innerHTML = `Î£ÏÎ½Î¿Î»Î¿: <b>0,00â‚¬</b>`;

      qtywrap.appendChild(step);
      qtywrap.appendChild(lineTotal);

      row.appendChild(img);
      row.appendChild(meta);
      row.appendChild(qtywrap);

      root.appendChild(row);
    }

    updateTotals();
  }

  function renderExtras() {
    const root = document.getElementById("extras");
    root.innerHTML = "";

    for (const ex of EXTRAS) {
      const row = document.createElement("div");
      row.className = "item";

      const img = document.createElement("img");
      img.className = "pic";
      img.alt = ex.name;
      setImgWithFallback(img, ex.imgBase);

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = ex.name;

      const sub = document.createElement("div");
      sub.className = "subrow";
      sub.innerHTML = `<span class="pill">Extra</span>`;

      meta.appendChild(name);
      meta.appendChild(sub);

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.id = ex.id;
      cb.style.width = "22px";
      cb.style.height = "22px";
      cb.style.justifySelf = "end";

      row.appendChild(img);
      row.appendChild(meta);
      row.appendChild(cb);
      root.appendChild(row);
    }
  }

  function getShippingSelected() {
    const arr = [];
    if (document.getElementById("ship_boxnow").checked) arr.push("BOX NOW");
    if (document.getElementById("ship_acs").checked) arr.push("ACS");
    if (document.getElementById("ship_metaforiki").checked) arr.push("ÎˆÏ‡Ï‰ Î´Î¹ÎºÎ® Î¼Î¿Ï… Î¼ÎµÏ„Î±Ï†Î¿ÏÎ¹ÎºÎ®");
    return arr;
  }

  function getExtrasSelected() {
    const arr = [];
    for (const ex of EXTRAS) {
      if (document.getElementById(ex.id).checked) arr.push(ex.name);
    }
    return arr;
  }

  function resetForm() {
    document.getElementById("afm").value = "";
    for (const p of PRODUCTOS) document.getElementById(p.id).value = "0";

    document.getElementById("ship_boxnow").checked = false;
    document.getElementById("ship_acs").checked = false;
    document.getElementById("ship_metaforiki").checked = false;

    for (const ex of EXTRAS) document.getElementById(ex.id).checked = false;

    document.getElementById("comment").value = "";
    updateTotals();
  }

  // âœ… envÃ­o Telegram robusto (muestra error real)
  async function sendTelegram(texto) {
    const res = await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: CHAT_ID, text: texto })
    });

    let data;
    try { data = await res.json(); } catch { throw new Error("Respuesta invÃ¡lida de Telegram"); }

    if (!res.ok || !data.ok) {
      throw new Error(data?.description || `HTTP ${res.status}`);
    }
    return true;
  }

  // init
  setImgWithFallback(document.getElementById("logo"), "img/logo");
  renderProductos();
  renderExtras();

  document.getElementById("btn").addEventListener("click", async () => {
    const afm = document.getElementById("afm").value.trim();
    const result = document.getElementById("result");
    result.innerHTML = "";

    // AFM: seguimos validando 9 dÃ­gitos, solo quitamos el texto/nota visual
    if (!/^\d{9}$/.test(afm)) {
      result.innerHTML = `<div class="bad">Î Î±ÏÎ±ÎºÎ±Î»Ï Î³ÏÎ¬ÏˆÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ Î‘Î¦Îœ.</div>`;
      return;
    }

    const shipping = getShippingSelected();
    if (shipping.length === 0) {
      result.innerHTML = `<div class="bad">Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï„ÏÏŒÏ€Î¿ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚.</div>`;
      return;
    }

    const items = [];
    let subtotal = 0;

    for (const p of PRODUCTOS) {
      const qty = getQty(p.id);
      if (qty > 0) {
        const line = qty * (Number(p.price)||0);
        subtotal += line;
        items.push({ name: p.name, qty, price: Number(p.price)||0, line });
      }
    }

    if (items.length === 0) {
      result.innerHTML = `<div class="bad">Î Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÏ…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î± ÏƒÎµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 Ï€ÏÎ¿ÏŠÏŒÎ½.</div>`;
      return;
    }

    const vat = subtotal * VAT_RATE;
    const total = subtotal + vat;

    const extras = getExtrasSelected();
    const comment = document.getElementById("comment").value.trim();

    const reg = await buscarPorAFM(afm);
    const epwnymia = reg?.epwnymia?.trim() ? reg.epwnymia : "Î‘Î¦Îœ no registrado en base de datos.";
    const onoma = reg?.onoma?.trim() ? reg.onoma : "â€”";

    let texto = `ğŸ“¦ ÎÎ­Î± Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±\n`;
    texto += `ğŸª ÎšÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±: ${epwnymia}\n`;
    texto += `ğŸ‘¤ ÎŒÎ½Î¿Î¼Î±: ${onoma}\n`;
    texto += `ğŸ§¾ Î‘Î¦Îœ: ${afm}\n\n`;

    texto += `ğŸ›ï¸ Î ÏÎ¿ÏŠÏŒÎ½Ï„Î±:\n`;
    for (const it of items) {
      texto += `â€¢ ${it.name}: ${it.qty} x ${eur(it.price)}â‚¬ = ${eur(it.line)}â‚¬\n`;
    }

    texto += `\nğŸ’¶ ÎšÎ±Î¸Î±ÏÎ® Î±Î¾Î¯Î±: ${eur(subtotal)}â‚¬\n`;
    texto += `ğŸ§¾ Î¦Î Î‘ 24%: ${eur(vat)}â‚¬\n`;
    texto += `âœ… Î£ÏÎ½Î¿Î»Î¿: ${eur(total)}â‚¬\n`;

    texto += `\nğŸšš Î¤ÏÏŒÏ€Î¿Î¹ Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚:\n`;
    for (const s of shipping) texto += `â€¢ ${s}\n`;

    if (extras.length) {
      texto += `\nğŸ Î¤Î± ÎµÎ¾Ï„ÏÎ±Î´Î±ÎºÎ¹Î± Î¼Î±Ï‚:\n`;
      for (const ex of extras) texto += `â€¢ ${ex}\n`;
    }

    if (comment) {
      texto += `\nğŸ“ Î£Ï‡ÏŒÎ»Î¹Î¿:\n${comment}\n`;
    }

    try {
      await sendTelegram(texto);
    } catch (err) {
      result.innerHTML = `<div class="bad">Telegram error: ${String(err.message || err)}</div>`;
      return;
    }

    alert("Î— Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î± ÏƒÏ„Î¬Î»Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ ÏƒÏ„Î¿ Telegram!");
    resetForm();
  });
</script>
</body>
</html>